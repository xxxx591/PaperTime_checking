function uploadPaperFile(object) {
    var pos = -1;
    var filePath = object.value;
    if (filePath.indexOf("/") > -1) {
        pos = filePath.lastIndexOf("/") * 1;
    } else if (filePath.indexOf("\\") > -1) {
        pos = filePath.lastIndexOf("\\") * 1;
    }
    var fileName = filePath.substring(pos + 1);
    var fileExtension = fileName.toLowerCase().substr(fileName.lastIndexOf('.'));
    if (!paperFileExtReg.test(fileExtension)) {
        layer.msg("只支持doc、docx或txt格式的文档");
        return;
    } else {
        $("#fileName").val(fileName);
        loading();
        $.ajaxFileUpload({
            url: '/submitTask/uploadCnkiReport.html',
            type: 'POST',
            secureuri: false,
            fileElementId: 'file',
            data: {systemId: $("#systemId").val()},
            dataType: 'json',
            success: function (json) {
                if (json.state) {
                    $("#paperPath").val(json.message);
                } else {
                    layer.msg(json.message);
                }
                layer.closeAll();
            },
            error: function () {
                layer.closeAll();
                layer.msg('提交文件失败，请重试!');
            }
        });
    }
}
$("#step1").click(function () {
    var title = $("#title").val();
    var author = $("#author").val();
    var majorId = $("#major").find('option:checked').val();
    var paperPath = $("#paperPath").val();
    if (!title) {
        layer.msg("请输入论文标题!");
        return;
    }
    if (title.length > 100) {
        layer.msg("论文标题请少于100字符!");
        return;
    }
    if (!author) {
        layer.msg("请输入论文作者!");
        return;
    }
    if (author.length > 20) {
        layer.msg("论文作者请少于20字符!");
        return;
    }
    if (majorId == 0) {
        layer.msg("请选择专业!");
        return;
    }
    if (!paperPath) {
        layer.msg("请上传论文!");
        return;
    }

    $("#step2-title").val(title);
    $(".report-one").hide();
    $(".report-two").show();
    //控制STEP
    $(".layui-input-inline-right > i").eq(0).addClass("ico-one").removeClass("ico-two");
    $(".layui-input-inline-right > i").eq(1).removeClass("ico-one").addClass("ico-two");
})

$(".prev-step").click(function () {
    $(".report-two").hide();
    $(".report-one").show();
    //控制STEP
    $(".layui-input-inline-right > i").eq(1).addClass("ico-one").removeClass("ico-two");
    $(".layui-input-inline-right > i").eq(0).removeClass("ico-one").addClass("ico-two");
})

$("#coupon").change(function () {
    var id = $(this).val();
    var money = parseInt($(this).find("option:selected").attr("cash"));
    var systemPrice = parseInt($("#systemPrice").val());
    if (id == 0) {
        $(".yhq-str").text('');
        $(".price").text(systemPrice);
    } else {
        $(".yhq-str").text('- ¥ ' + money);
        $(".price").text(systemPrice - money);
    }
})

var timer;
$(".layui-btn-qr").click(function () {
    var payType = $("input[name='payType']:checked").val();
    var data = {
        title: $("#title").val(),
        author: $("#author").val(),
        systemId: $("#systemId").val(),
        coupon: $("#coupon").find("option:selected").val(),
        majorId: $("#major").find('option:checked').val(),
        readUrl:$("#paperPath").val(),
        payType: payType,
    }
    var index = loading();
    $.ajax({
        url: "/submitTask/saveCnkiTask.html",
        method: "post",
        data: data,
        success: function (json) {
            layer.close(index);
            if (json.state) {
                alipay(json.param.url, json.param.amount, payType)
                timer = setInterval('validateOrderStatus("' + json.param.orderNum + '")', 1000);
            } else {
                layer.msg(json.message);
            }

        }, error: function () {
            layer.close(index);
        }
    })
})
function validateOrderStatus(orderNum) {
    $.getJSON("/submitTask/validateOrderStatus.html", {orderNum: orderNum}, function (json) {
        if (json.state) {
            clearInterval(timer);
            layer.closeAll();

            $("#step3-title").text($("#title").val());
            $("#cost").text('¥' + $(".price").eq(0).text());
            $(".report-two").hide();
            $(".report-three").show();
            //控制STEP
            $(".layui-input-inline-right > i").eq(1).addClass("ico-one").removeClass("ico-two");
            $(".layui-input-inline-right > i").eq(2).removeClass("ico-one").addClass("ico-two");
        }
    })
}


function alipay(url, amount, payType) {
    var title = "支付宝扫一扫支付";
    if ("wxPay" == payType) {
        title = "微信扫一扫支付";
    }
    layer.open({
        title: '支付' + amount + '元',
        type: 1,
        area: ['475px', '445px'],
        content: '<div class="box-layer box-layer-ewm">' +
        '<div class="box-ewm">' +
        '<strong>' + title + '</strong>' +
        '<div class="ewm-img"><img src="' + url + '"></div>' +
        '<span>请在二小时内完成支付！</span>' +
        '<hr/><a href="javascript:chooseOther();">使用其他方式支付></a> </div> ' +
        '</div>',
        success: function (layero, index) {
            $('.btn-x,.btn-no').click(function () {
                layer.close(index)
            })
        }, cancel: function () {
            clearInterval(timer);
        }
    })
}

function chooseOther(index) {
    clearInterval(timer);
    layer.closeAll();
}

