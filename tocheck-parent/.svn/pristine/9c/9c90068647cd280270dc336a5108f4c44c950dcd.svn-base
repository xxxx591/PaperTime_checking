package com.tocheck.parent.web.util;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import com.github.pagehelper.PageInfo;
import com.tocheck.parent.common.constans.Constants;
import com.tocheck.parent.common.util.CommonUtil;
import com.tocheck.parent.common.util.HttpClientUtil;
import com.tocheck.parent.common.util.SSDBUtils;
import com.tocheck.parent.core.service.ToCheckTaskService;
import com.tocheck.parent.core.vo.ToCheckTaskVo;
import org.apache.commons.lang3.StringUtils;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.net.URLEncoder;
import java.security.MessageDigest;
import java.util.*;

@Component
public class PaperPassUtil {


    @Autowired
    private ToCheckTaskService toCheckTaskService;

    private static final Logger logger = LogManager.getLogger(PaperPassUtil.class);

    @Autowired
    private SSDBUtils ssdbUtils;

    private static final String STATUS = "status";

    private static final String SYSTEM_IP = "127.0.0.1";

    private static final String USER_NAME = "tocheck";

    private static final String APP_KEY = "5845155412";

    private static final String APP_SECRET = "MIIEvQIBADANBgkqhkiG9w0DASJDLKAJJP";

    private static final String SUBMIT_CHECK_TASK = "http://www.paperpass.cx/api/submitCheckTask.html";

    private static final String QUERY_CHECK_TASK = "http://www.paperpass.cx/api/query.html";


    public void submitCheckTask() {
        try {
            PageInfo<ToCheckTaskVo> pageInfo = toCheckTaskService.canCheckTask(6, Constants.CHECK_STATUS_WAIT);
            for (ToCheckTaskVo vo : pageInfo.getList()) {
                Long time = System.currentTimeMillis();
                String nonce_str = CommonUtil.buildRandomNum(6);
                List<String> signParam = new ArrayList<>();
                signParam.add(USER_NAME);
                signParam.add(APP_KEY);
                signParam.add(SYSTEM_IP);
                signParam.add(time.toString());
                signParam.add(nonce_str);
                signParam.add(vo.getTitle());
                signParam.add(vo.getAuthor());

                Map<String, Object> queryMap = new HashMap<>();
                queryMap.put("user_name", USER_NAME);
                queryMap.put("app_key", APP_KEY);
                queryMap.put("client_ip", SYSTEM_IP);
                queryMap.put("timestamp", time);
                queryMap.put("nonce_str", nonce_str);
                queryMap.put("content", ssdbUtils.getValue("tocheck-task-" + vo.getId()));
                queryMap.put("title", vo.getTitle());
                queryMap.put("author", vo.getAuthor());
                queryMap.put("sign", sign(signParam, APP_SECRET));
                String result = HttpClientUtil.doHttpClientPost(SUBMIT_CHECK_TASK, JSON.toJSONString(queryMap));
                JSONObject object = JSON.parseObject(result);
                logger.info("当前任务ID={},请求结果object={}", vo.getId(), object);
                if (object != null && object.getBoolean(STATUS)) {
                    Long checkId = object.getLong("data");
                    if (checkId != null) {
                        toCheckTaskService.updateTaskStatus(vo.getId(), Constants.CHECK_STATUS_CHECKING, checkId);
                        ssdbUtils.del("finalCheckTask-content-" + vo.getId());
                    }
                } else if (object != null && !object.getBoolean(STATUS)) {
                    toCheckTaskService.updateErrorMsg(vo.getId(), object.getString("message"));
                }
            }

        } catch (Exception e) {
            logger.error("提交定稿终检论文失败e={}", e);
        }
    }


    public void updateCheckTaskStatus() {
        try {
            PageInfo<ToCheckTaskVo> pageInfo = toCheckTaskService.canCheckTask(6, Constants.CHECK_STATUS_CHECKING);
            for (ToCheckTaskVo vo : pageInfo.getList()) {
                toCheckTaskService.updateTaskStatus(vo.getId(),Constants.CHECK_STATUS_REPORT);
                Long time = System.currentTimeMillis();
                String nonce_str = CommonUtil.buildRandomNum(6);
                List<String> signParam = new ArrayList<>();
                signParam.add(USER_NAME);
                signParam.add(APP_KEY);
                signParam.add(SYSTEM_IP);
                signParam.add(time.toString());
                signParam.add(nonce_str);
                signParam.add(String.valueOf(vo.getCheckId()));

                Map<String, Object> queryMap = new LinkedHashMap<>();
                queryMap.put("user_name", USER_NAME);
                queryMap.put("app_key", APP_KEY);
                queryMap.put("client_ip", SYSTEM_IP);
                queryMap.put("timestamp", time);
                queryMap.put("nonce_str", nonce_str);
                queryMap.put("check_id", vo.getCheckId());
                queryMap.put("sign", sign(signParam, APP_SECRET));
                String result = HttpClientUtil.doHttpClientPost(QUERY_CHECK_TASK, JSON.toJSONString(queryMap));
                JSONObject object = JSON.parseObject(result);
                if (object != null && object.getBoolean(STATUS)) {
                    JSONObject jsonObject = object.getJSONObject("data");
                    if (jsonObject != null) {
                        if (jsonObject.getIntValue(STATUS) == Constants.CHECK_STATUS_REPORT_ERROR) {
                            toCheckTaskService.updateErrorMsg(vo.getId(), "生成报告出错，请联系卖家，");
                        }
                        if (jsonObject.getIntValue(STATUS) == Constants.CHECK_STATUS_CHECK_ERROR) {
                            toCheckTaskService.updateErrorMsg(vo.getId(), "检测出错，请联系卖家");
                        }
                        if (jsonObject.getIntValue(STATUS) ==  Constants.CHECK_STATUS_FINISH) {
                            toCheckTaskService.finishCheck(vo.getId(), Constants.CHECK_STATUS_FINISH, jsonObject.getString("checkResult"));
                        }
                    }
                }else if (object != null && !object.getBoolean(STATUS)) {
                    toCheckTaskService.updateErrorMsg(vo.getId(), object.getString("message"));
                }
            }
        } catch (Exception e) {
            logger.error("定稿终检论文查询失败e={}", e);
        }
    }

    public static String sign(List<String> params, String appSecret) {
        Collections.sort(params);
        StringBuilder string1 = new StringBuilder(16);
        for (String string : params) {
            string1.append(string);
        }
        string1.append(appSecret);
        try {
            String sign = URLEncoder.encode(string1.toString(), "UTF-8");
            logger.info("签名前数据:sign={}", sign);
            MessageDigest crypt = MessageDigest.getInstance("SHA-1");
            crypt.reset();
            crypt.update(sign.getBytes("UTF-8"));
            return byteToHex(crypt.digest());
        } catch (Exception e) {
            logger.error("服务器签名失败params={}", params, e);
        }
        return null;
    }


    public static String byteToHex(final byte[] hash) {
        Formatter formatter = new Formatter();
        for (byte b : hash) {
            formatter.format("%02x", b);
        }
        String result = formatter.toString();
        formatter.close();
        return result;
    }
}
