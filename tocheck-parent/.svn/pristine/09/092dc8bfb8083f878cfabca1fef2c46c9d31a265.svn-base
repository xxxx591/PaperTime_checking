package com.tocheck.parent.core.utils;

import com.github.pagehelper.PageInfo;
import com.tocheck.parent.common.constans.Constants;
import com.tocheck.parent.common.util.SSDBUtils;
import com.tocheck.parent.core.dao.IToCheckTaskDao;
import com.tocheck.parent.core.service.ToCheckTaskService;
import com.tocheck.parent.core.vo.ToCheckTaskVo;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Lazy;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

/**
 * @author pangliang
 * @create 2016-12-23 14:23
 **/
@Component
@Lazy(false)
public class ScheduledUtil {

    @Autowired
    private PaperPassUtil paperPassUtil;
    @Autowired
    private PaperFreeUtil paperFreeUtil;
    @Autowired
    private PaperTimeUtil paperTimeUtil;
    @Autowired
    private ToCheckTaskService toCheckTaskService;
    @Autowired
    private SSDBUtils ssdbUtils;
    @Autowired
    private IToCheckTaskDao toCheckTaskDao;

    private static final String os = System.getProperty("os.name").toLowerCase();

    private ExecutorService exec = Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors());

    //    @Scheduled(fixedDelay = 1 * 1000)
    public void paperPassSubmitCheckTask() {
        if (os.indexOf("linux") >= 0) {
            paperPassUtil.submitCheckTask();
        }
    }

    //    @Scheduled(fixedDelay = 1 * 1000)
    public void paperPassUpdateCheckTaskStatus() {
        if (os.indexOf("linux") >= 0) {
            paperPassUtil.updateCheckTaskStatus();
        }
    }

    @Scheduled(fixedDelay = 1 * 1000)
    public void paperFreeSubmitCheckTask() {
        if (os.indexOf("linux") >= 0) {
            paperFreeUtil.submitCheckTask();
        }
    }

    @Scheduled(fixedDelay = 1 * 1000)
    public void paperFreeUpdateCheckTaskStatus() {
        if (os.indexOf("linux") >= 0) {
            paperFreeUtil.updateCheckTaskStatus();
        }
    }

    @Scheduled(fixedDelay = 1 * 1000)
    public void paperTimeSubmitCheckTask() {
        if (os.indexOf("linux") >= 0) {
            paperTimeUtil.submitCheckTask();
        }
    }

    @Scheduled(fixedDelay = 1 * 1000)
    public void paperTimeUpdateCheckTaskStatus() {
        if (os.indexOf("linux") >= 0) {
            paperTimeUtil.updateCheckTaskStatus();
        }
    }

    @Scheduled(fixedDelay = 1 * 1000)
    public void wanFangCheckTask() {
        if (os.indexOf("linux") >= 0) {
            PageInfo<ToCheckTaskVo> pageInfo = toCheckTaskService.canCheckTask(Constants.CHECK_SYSTEM_WANFANG, Constants.CHECK_STATUS_WAIT);
            for (ToCheckTaskVo vo : pageInfo.getList()) {
                exec.execute(new WanFangUtil(vo, toCheckTaskService, ssdbUtils));
            }
        }
    }

    @Scheduled(fixedDelay = 1 * 1000)
    public void updateSettlementStatus() {
        if (os.indexOf("linux") >= 0) {
            toCheckTaskDao.updateSettlementStatus();
        }
    }
}

