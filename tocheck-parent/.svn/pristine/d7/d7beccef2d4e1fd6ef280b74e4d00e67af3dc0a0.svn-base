//package com.tocheck.parent.web.util;
//
//import com.alibaba.fastjson.JSON;
//import com.meterware.httpunit.*;
//import com.papertime.common.util.common.CommonUtil;
//import com.papertime.common.util.common.DateUtil;
//import com.papertime.common.util.common.FileToZipUtil;
//import com.papertime.parent.tocheck.common.CommonProperties;
//import com.papertime.parent.tocheck.entity.CheckRecord;
//import com.papertime.parent.tocheck.entity.FileUpload;
//import org.apache.commons.io.FileUtils;
//import org.slf4j.Logger;
//import org.slf4j.LoggerFactory;
//import org.springframework.util.FileCopyUtils;
//
//import java.io.ByteArrayInputStream;
//import java.io.File;
//import java.util.*;
//import java.util.concurrent.Callable;
//
///**
// * @author pangliang
// * @create 2017-01-13 11:34
// **/
//public class TurnitinUK implements Callable<Map<String, Object>> {
//
//    private static final Logger logger = LoggerFactory.getLogger(Turnitin.class);
//
//    private static final String LOGIN_API = "https://www.turnitinuk.com/login_page.asp?lang=zh_hans";
//
//    private static final String SUBMIT_CP = "https://www.turnitinuk.com/t_submit_cp.asp?r=55.4785925000218&svr=306&lang=zh_hans&aid={0}";
//
//    private static final int SLEEP_TIME = 10 * 60 * 1000;  //10分钟
//
//    private CheckRecord checkRecord;
//
//    private String filePath;
//
//    private String account;
//
//    private String password;
//
//    public TurnitinUK(CheckRecord checkRecord, String filePath, String account, String password) {
//        this.checkRecord = checkRecord;
//        this.filePath = filePath;
//        this.account = account;
//        this.password = password;
//    }
//
//    @Override
//    public Map<String, Object> call() throws Exception {
//        Map<String, Object> resultMap = new HashMap<>();
//        try {
//            HttpUnitOptions.setScriptingEnabled(false);
//            WebConversation wc = new WebConversation();
//            //登录
//            WebRequest req_post = new PostMethodWebRequest(LOGIN_API);
//            req_post.setParameter("email", account);
//            req_post.setParameter("user_password", password);
//            WebResponse resp = wc.getResponse(req_post);
//
//            HTMLElement[] element = resp.getElementsByTagName("a");
//            String class_home_url = "";
//            for (HTMLElement e : element) {
//                String href = e.getAttribute("href");
//                if (href !=null && e.getAttribute("href").indexOf("t_class_home.asp") != -1) {
//                    class_home_url = e.getAttribute("href");
//                    break;
//                }
//            }
//            if(class_home_url ==""){  //没有课程
//                logger.warn("当前账号account={},password={},没有创建课程",account,password);
//                return null;
//            }
//            logger.info("class_home_url={}",class_home_url);
//
//            //作业列表
//            WebRequest req_get = new GetMethodWebRequest("https://www.turnitinuk.com/"+class_home_url);
//            resp = wc.getResponse(req_get);
//
//            element = resp.getElementsByTagName("a");
//            String t_inbox = "";
//            for (HTMLElement e : element) {
//                String href = e.getAttribute("href");
//                if (href !=null && e.getAttribute("href").indexOf("t_inbox.asp") != -1) {
//                    t_inbox = e.getAttribute("href");
//                    break;
//                }
//            }
//            if(t_inbox ==""){
//                logger.warn("当前账号account={},password={},没有创建作业",account,password);
//                return null;
//            }
//            logger.info("t_inbox_url={}",t_inbox);
//            String aid = t_inbox.substring(t_inbox.indexOf("aid="));
//            aid = aid.replace("aid=","");
//
//            logger.info("t_submit_url={}",SUBMIT_CP.replace("{0}",aid));
//            //提交论文
//            req_get = new GetMethodWebRequest(SUBMIT_CP.replace("{0}",aid));
//            resp = wc.getResponse(req_get);
//            req_post = new PostMethodWebRequest(wc.getCurrentPage().getURL().toString());
//            req_post.setParameter("userID", "");
//            req_post.setParameter("author_first", "None");
//            req_post.setParameter("author_last", "None");
//            req_post.setParameter("title", new String(checkRecord.getTitle().getBytes("utf-8"), "ISO-8859-1"));
//
//            String paper = new String(txt2String(filePath));
//            byte[] b = paper.getBytes("utf-8");//编码
//            req_post.setParameter("main_text", new String(b, "ISO-8859-1"));
//
//            req_post.setParameter("submit_button", "");
//            resp = wc.getResponse(req_post);
//            String rcpt = resp.getURL().toString();
//            logger.info("提交成功页面url={}", rcpt);
//            rcpt = rcpt.substring(rcpt.indexOf("oid="));
//            rcpt = rcpt.substring(0, rcpt.indexOf("&"));
//            rcpt = rcpt.replace("oid=", "");
//            Long oid = Long.parseLong(rcpt);
//            logger.info("论文ID={}", oid);
//
//            Thread.sleep(SLEEP_TIME);  //等待10分钟,再去读取报告.
//
//            req_get = new GetMethodWebRequest("https://www.turnitinuk.com/newreport.asp?r=62.145066298692&svr=335&lang=zh_hans&oid=" + oid + "&pbd=2&ft=1&ro=103");
//            resp = wc.getResponse(req_get);
//
//            req_get = new GetMethodWebRequest("https://www.turnitinuk.com/newreport_printview.asp?r=16.546841992853835&svr=340&d=1&lang=zh_hans");
//            resp = wc.getResponse(req_get);
//
//            String datePath = DateUtil.getDate(new Date(), "yyyyMMdd");
//            String p = "/report/" + datePath + "/" + checkRecord.getMemberId();
//            String writeFilePath = CommonProperties.instance.file_upload + p;
//            File uploadfile = new File(writeFilePath);
//            if (!uploadfile.exists() && !uploadfile.isDirectory()) {
//                uploadfile.mkdirs();
//            }
//            String newFileName = System.currentTimeMillis() + CommonUtil.buildRandomNum(10) + ".html";
//            File uploadFile = new File(writeFilePath + File.separator + newFileName);
//            FileUtils.copyInputStreamToFile(new ByteArrayInputStream(resp.getBytes()), uploadFile);
//
//            List<File> files = new ArrayList<File>();
//            files.add(uploadFile);
//            newFileName = System.currentTimeMillis() + CommonUtil.buildRandomNum(10) + ".zip";
//            FileToZipUtil.multiFileToZip(files, writeFilePath + File.separator + newFileName);
//            uploadFile.delete();
//
//            //保存文件信息
//            FileUpload fileUpload = new FileUpload();
//            fileUpload.setFilename(newFileName);
//            fileUpload.setFileOriName(newFileName);
//            fileUpload.setFilePath(writeFilePath + "/" + newFileName);
//            fileUpload.setFileUrl(CommonProperties.instance.file_request + p + "/" + newFileName);
//            fileUpload.setDeleteStatus(1);
//            resultMap.put("fileUpload", fileUpload);
//            resultMap.put("checkRecord", checkRecord);
//            resultMap.put("state", true);
//            logger.info("检测记录ID={},返回参数={}", checkRecord.getId(), JSON.toJSONString(resultMap));
//            return resultMap;
//        } catch (Exception e) {
//            e.printStackTrace();
//            logger.error("提交检测ID={}出现错误",checkRecord.getId());
//            return null;
//        }
//
//    }
//
//    public static String txt2String(String path) throws Exception {
//        String fileContent = "";
//        File f = new File(path);
//        if (f.isFile() && f.exists()) {
//            fileContent = FileUtils.readFileToString(f, "utf-8");
//        }
//        return fileContent;
//    }
//}
